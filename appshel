using Mauiws.Model;
using System.Collections.ObjectModel;
using System.Text.Json;

namespace Mauiws;

public partial class AssetsPage : ContentPage
{
    private readonly HttpClient _httpClient;

    private ObservableCollection<AssetTypeDto> _assetTypes = new();
    private ObservableCollection<AssetDto> _assets = new();

    public AssetsPage()
    {
        InitializeComponent();

        _httpClient = new HttpClient
        {
            BaseAddress = new Uri("https://localhost:7152/") // поменяй порт/URL при необходимости
        };

        TypePicker.ItemsSource = _assetTypes;
        AssetsList.ItemsSource = _assets;
    }

    protected override async void OnAppearing()
    {
        base.OnAppearing();
        await LoadAssetTypesAsync();
        await LoadAssetsAsync();
    }

    private async Task LoadAssetTypesAsync()
    {
        try
        {
            var response = await _httpClient.GetAsync("api/assettypes");
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var types = JsonSerializer.Deserialize<List<AssetTypeDto>>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            _assetTypes.Clear();
            _assetTypes.Add(new AssetTypeDto { AssetTypeId = 0, Name = "Все типы" });
            if (types != null)
            {
                foreach (var t in types)
                    _assetTypes.Add(t);
            }

            TypePicker.SelectedIndex = 0;
        }
        catch (Exception ex)
        {
            await this.DisplayAlertAsync("Ошибка", $"Не удалось загрузить типы активов:\n{ex.Message}", "OK");
        }
    }

    private async Task LoadAssetsAsync()
    {
        try
        {
            int? typeId = null;

            if (TypePicker.SelectedItem is AssetTypeDto selected && selected.AssetTypeId > 0)
                typeId = selected.AssetTypeId;

            string url = "api/assets";
            if (typeId.HasValue)
                url += $"?typeId={typeId.Value}";

            var response = await _httpClient.GetAsync(url);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var list = JsonSerializer.Deserialize<List<AssetDto>>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            _assets.Clear();
            if (list != null)
            {
                foreach (var a in list)
                    _assets.Add(a);
            }
        }
        catch (Exception ex)
        {
            await this.DisplayAlertAsync("Ошибка", $"Не удалось загрузить типы активов:\n{ex.Message}", "OK");
        }
    }

    private async void RefreshButton_Clicked(object sender, EventArgs e)
    {
        await LoadAssetsAsync();
    }

    private async void TypePicker_SelectedIndexChanged(object sender, EventArgs e)
    {
        await LoadAssetsAsync();
    }
}
